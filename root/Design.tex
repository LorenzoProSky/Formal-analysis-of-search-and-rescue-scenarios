
\section{Model Description}
From here after the word \textit{entity} refers to civilians, first-responders or drones (and all of their subcategories), while \textit{object} refers to fire and exit. Each entity is uniquely identified among other entities of the same type by an id. While going through the different aspects and sections of the model, the corresponding design decisions will also be directly highlighted and explained.


\subsection{Layout}
\paragraph{Map and Positions}
\label{sec:map}
The modelling of the emergency area is achieved by a 2D array, called for simplicity map. In addition, the position of each entity is specified in its respective 1D array, where the particular entity is identified by its index and each element of the array is a pair of coordinates (referring to the map).\newline
Each map cell contains only one value, and each cell type value has a different meaning. The most meaningful and critical decisions to explain are two. The first one is the absence of a drone-value in the map, deemed superfluous and a complicating factor due to the following considerations: drones can fly over other entities and objects, and the drone moving policy adopted (explained in section~\ref{sec:drone}). The second point is the values of \textit{SAFE} and \textit{CASUALTY}, which are different in principle (to distinguish the two states inside model logic), but then are written in the map as the same, \textit{FREE}. This last choice was done because when civilians are saved or die, they are no longer part of the scenario, so the cell that they once occupied should be now free and their position in the respective array removed.
\paragraph{General Movement and Detection}
Entities can move following their respective moving policy inside the map, updating it and their position arrays. The following \textit{simplifying assumption} was made: entities can only move in the four cardinal directions. From this point stems the fact that distances between cells is calculated via Manhattan distance. This choice was made to simplify the moving policy without loss of generality, since the model can be easily extended with eight-direction movement without impacting the overall model and logic. On the other hand, entities can detect other entities and objects in all directions. This choice was made to simulate the idealistic behaviour of entities, which could not be simplified like for the moving policy. This decision places greater emphasis on the detection policies rather than on the moving policies.


\subsection{Communication}
As it will be clearly explained in future sections, entities have the need to communicate in a particular fashion sharing specfic information.
\paragraph{Channels}
A given entity need to synchronize with a specific entity over a channel, to achieve this binary correspondence channel arrays were utilized, where the specific target entity for that channel is identified by its id. Each channel is clearly named according the communication that it represents.
\paragraph{Message Passing}
In addition to synchronization, entities also need to pass information between each other and to solve this problem a communication mechanism was implemented. At the core of the system there are messages (single or double, depending on the number of values contained), then each entity will have its own inbox containing a single message and finally all of them are grouped into a single array of inboxes (identified by their id), contained in a global structure (communication purpose specific). The model simulates a postman carrying letters to different recipients, managing all of the message passing and cleaning the inboxes whenever necessary (if not strictly necessary an inbox is not cleaned).


\subsection{Termination}
In a real-life scenario a rescue operation cannot continue indefinitely, drones will run out of battery, first-responders will get tired and civilians who are not rescued in time will become missing civilians. To model this important aspect, every entity has its own "tiredness meter" implemented by an integer in their respective indexed arrays (properly named). The single counter measures how much an entity is "tired" and not how much energy is left (for ease of implementation without clarity loss). Whenever, an entity does a meaningful amount of work (which also is worth to be accounted for), its counter will increases until it reaches its "max tiredness threshold" after which the entity will not be able to do any more work. This aspect will not be further discussed in the templates, if not to point out interesting and meaningful details. Each entity category has its own single threshold, this could be expanded into a new parameter for each entity.


\subsection{Templates}
The model is based on the following 4 templates:
\begin{itemize}
	\item \textit{Initializer}: helping template to initialize the scene and the various used data structures.
	\item \textit{Civilian}: person in need of rescue inside the emergency area, who can be saved, die or get missing and who can receive instructions by a drone.
	\item \textit{First-Responder}: trained professional rescuing civilians inside the emergency area.
	\item \textit{Drone}: autonomous flying entity, which has the objective of instructing civilians in the best way possible to maximizing rescue rate.
\end{itemize}


\subsubsection{Initializer}
Simple automaton to correctly populate the map with entities and to initialize all the global data structures. Following this initialization all the other automata are signalled to start.


\subsubsection{Civilian}
A civilian can be:
\begin{itemize}
	\item \textit{CIVILIAN}: default civilian, also referred to as survivor.
	\item \textit{SAFE}: saved civilian.
	\item \textit{VICTIM}: civilian near a fire.
	\item \textit{CASUALTY}: civilian no longer alive.
	\item \textit{IN\_ASSISTANCE}: victim who is being assisted by a responder.
	\item \textit{ZERO\_RESPONDER}: civilian who was instructed by a drone to help a victim.
	\item \textit{IN\_CONTACT}: civilian who was instructed by a drone to contact a first-responder.
	\item \textit{EXHAUSTED\_CIVILIAN}: cilian who is too tired to move.
\end{itemize}

\noindent
All these different subcategories were used to explicitly model the different conceptual states in which a civilian can be in and their evolution during a scenario. In addition, this clear distinction enables the model to utilize more precise, easier and cleaner logics and to avoid many problems related to miss-communication or multi-communication.\newline

\noindent
A civilian is characterized by the following parameters:
\begin{itemize}
	\item \textit{civilian\_id}
	\item \textit{tv}: time in seconds before a victim dies, becoming a casualty.
	\item \textit{tzr}: time in seconds needed for a zero-responder to rescue a victim.
\end{itemize}

\paragraph{Behaviour}
What follows is the general behaviour and the most important aspects of the civilian template, not all transitions, states and details will be discussed.\newline
A civilian can check its surroundings up to 1-cell distance.

\begin{enumerate}
	\item A civilian starts off by going through three initial committed states in which it is checked if it is \textit{safe}, \textit{victim} or \textit{exhausted civilian}, if none of those are true it ends up in an \textit{Idle} state. The committed nature of these first two states is fundamental, since no other entity can move apart for civilians (can interleave their actions) and this assures that the model behaves as intended. Because at each step of a civilian, before any other entity can do anything, that civilian will correctly update its state, not misleading any other entity by being in a wrong state. In addition, this also works perfectly for the initialization phase of the civilians in the map.
	
	\item When a civilian becomes a \textit{victim}, it will become a \textit{casualty} after \textit{tv} time. However, if in this period of time it is assisted by a responder, it can be saved. If the civilian is \textit{in assistance} and becomes a \textit{casualty} this event will be synchronized with the responder.\newline
	What happens when a civilian becomes \textit{safe} or \textit{casualty} inside the map has been already described in section~\ref{sec:map}.
	
	\item When a civilian becomes an \textit{exhausted civilian}, it will be unable to move any further. If a first-responder sees it, it can still be rescued and saved. However, if all drones and first-responders have finished their energy, the rescue is considered completed and the civilian will become a missing civilian. There is no value type for this last status, since it is not needed in the map.
	
	\item From the \textit{Idle} state, a \textit{civilian} can be contacted by a drone or it can move randomly (\textit{civilian moving policy}).
	
	\item When it is contacted by a drone, it can be instructed to become a \textit{zero-responder} or an \textit{in contact} civilian. The committed states are fundamental to create atomic transactions, while the non-committed ones are needed to let time pass.
	
	\begin{enumerate}
		\item In the \textit{zero-responder} case, the civilian will read the message sent by the drone to know which \textit{victim} to assist. After that it will perform the rescue as a responder. If the \textit{victim} becomes a \textit{casualty} before the end of the rescue, the \textit{zero-responder} will still end its own rescue.
		
		\item In the \textit{in contact} case, the civilian will read the message sent by the drone to know which \textit{first-responder} to contact and which \textit{victim} is in need of assistance. Firstly, the civilian enacts the moving towards the \textit{first-responder} to contact it, taking \textit{distance between itself and the first-responder} time. When it arrives, it waits for the \textit{first-responder} to be free and then communicate who needs assistance. After that, it will be saved by the first-responder.\newline
		It might happen that while the civilian is reaching the first-responder or is waiting for the first-responder to be free, the \textit{victim} is no longer in need of assistance (be it already saved, a casualty or in assistance) and in this case the civilian will not contact the first-responder. This choice was made not to waste the precious time of the first-responder. In addition, it is based on the decision policy of the drone (described in section~\ref{sec:drone}). Finally, the first-responder does not assist the contacting survivor even if it is waiting (near the first-responder), because the contacting survivor is not in need of assistance and the rescue has not yet started. So the first-responder should prioritize rescuing other victims, while (in a real scenario) just instructing the contacting survivor to go to the nearest exit.
	\end{enumerate}
\end{enumerate}


\paragraph{Stochastic Version}
To account for the stochastic features the civilian template has been expanded:
\begin{itemize}
	\item New civilian parameter \textit{plisten}: probability expressed by an integer [0, 100], that a civilian when given an instruction by a drone follows it.
	\item New probabilistic transition: when a civilian is contacted by a drone, now there is a branch point. A civilian will follow the instruction (accepting the communication) only with probability \textit{plisten}, while it will ignore it with probability \textit{100 - plisten}. This simulates the unpredictability of untrained civilians under stress.
	\item New channel \textit{civilian\_noncompliance\_msg} and global communication structure \textit{global\_drone\_comm\_civilian}: these two additions (and the necessary ones that follow) are necessary to make the drone aware that the civilian did not follow the given instruction and to act accordingly.
\end{itemize}
	
\subsubsection{First-Responder}
A first-responder can be:
\begin{itemize}
	\item \textit{FIRST\_RESPONDER}: default first-responder.
	\item \textit{CONTACTED\_FIRST\_RESPONDER}: first-responder who is being contacted by a survivor.
	\item \textit{FATIGUED\_FIRST\_RESPONDER}: first-responder who is too tired to continue the rescue.
\end{itemize}

\noindent
This differentiation was made to ensure that: no two drones could detect the same first-responder (according to the decision policy of the drone described in section~\ref{sec:drone}), no drone could detect a \textit{fatigued first-responder} and to give a higher priority to the assisting of a contacting survivor and the corresponding victim, since this action can save two civilians instead of one.\newline

\noindent
A first-responder is characterized by the following parameters:
\begin{itemize}
	\item \textit{first\_responder\_id}
	\item \textit{tfr}: time in seconds needed for a first-responder to rescue a victim.
\end{itemize}

\paragraph{Behaviour}
What follows is the general behaviour and the most important aspects of the first-responder template, not all transitions, states and details will be discussed.\newline
A first-responder can check its surroundings up to 1-cell distance.

\begin{enumerate}
	\item A first-responder starts off in an \textit{Idle} state. From here, respecting the precedence of actions earlier discussed, if it is not fatigued it can check its surroundings to look for a \textit{victim} or \textit{exhausted civilian} to help. If there is more than one civilian detected, it will try to save the one with largest \textit{tv} (\textit{first-responder detection policy}). This decision stems from the observation that in a real-life scenario the first-responder must make a decision regarding who to help first and since the \textit{tfr} is fixed (every assistance takes the same amount of time), it makes sense that the first-responder will try to save the civilian with the highest possibility to live. The model could be extended to work with variable \textit{tfr}, depending on different factors to simulate this aspect of an emergency rescue (different rescue types should require different \textit{tfr}s) or it could support different priorities for different civilian types (e.g. children, men, women, elderly, etc.).
	\begin{enumerate}
		\item If a first-responder detects a \textit{victim} to help, it will start the rescue and complete it in \textit{tfr} time. If the \textit{victim} dies during the rescue becoming a \textit{casualty}, then the rescue is aborted and the first-responder returns to the \textit{Idle} state.
		\item If a first-responder does not detect a \textit{victim} to help, it will move randomly (\textit{first-responder moving policy}). It is worth pointing out, that the first-responder also has as a valid option to remain in the same position. This decision was made for consistency purposes, because in the model a first-responder can assist civilians also in impossible situations (e.g. exit completed surrounded by fire) and so a first-responder should still be able to assist civilians even if it is trapped (unable to move), and to do so, it needs to transition from \textit{Wandering} state to \textit{Idle} state without moving.
	\end{enumerate}
	The fact that after the detection of a \textit{victim} there is a committed state is fundamental to ensure atomic actions and avoid conflicts, since no other entity should be able to detect it as a \textit{victim} (e.g. other first-responders or drones) and act upon that detection. This models a possible and plausible rescue coordination mechanism among entities during an emergency.\newline
	Moreover, it is also fundamental the distinction between this committed state and the \textit{Wandering} state, in order to avoid possible deadlocks (also prevented by the discussed moving policy).\newline
	No other interaction can happen when a first-responder is fatigued, because it cannot be detected by drones. To achieve this, it was mandatory to use the function \textit{fEnergyUsed} when detecting victims, even tough is not completely true in real-life, since the first-responder should get tired after performing the action and in this way the first-responder is already fatigued when it will make the last rescue or step.
	
	\item When a first-responder is being contacted (\textit{contacted first-responder}), after finishing its previous rescue or movement, it will assist the \textit{contacting survivor} and the \textit{victim} communicated by the survivor. It will help both of them in \textit{tfr + distance between itself and the victim} time. However, if in this period of time the \textit{victim} dies becoming a \textit{casualty}, the first-responder will still finish rescuing the \textit{contacting survivor}, since the rescue has already started and completely aborting it would mean losing all the progress already made, wasting precious time.
	
\end{enumerate}

\subsubsection{Drone}
\label{sec:drone}
As discussed in section~\ref{sec:map}, drones are not represented in the map, so they do not have any value type.\newline
Drones have been modelled as if they would be all deployed from one side of the map (without loss of generality, the top) with the aim of maximizing the covered area, so they are meaningfully spaced apart. Not only this design choice increases their rescue capabilities, but it also prevents most (not all) communication conflicts between them.\newline

\noindent
A drone is characterized by the following parameters:
\begin{itemize}
	\item \textit{drone\_id}
	\item \textit{nv}: range in cells in which a drone can detect other entities.
\end{itemize}

\paragraph{Behaviour}
What follows is the general behaviour and the most important aspects of the drone template, not all transitions, states and details will be discussed.

\begin{enumerate}
	\item A drone starts off in an \textit{Idle} state. From here it can scan its surrounding area to detect meaningful entities, if it is not energy drained. The \textit{drone detection policy} is as follows: it will scan within a square radius of \textit{nv} cells its surroundings, looking for \textit{survivor}s, \textit{victim}s and \textit{first-responder}s; if there is more than one entity for a specific category, it will choose the closest one. The following assumption was made: a drone does not have the capability to choose the victim with the highest possibility to live (like a first-responder can). The drone can only detect \textit{victim}s and not \textit{exhausted civilian}s, since it cannot distinguish between them and a normal \textit{civilian}s. In addition, if the model would be extended to support variable first-responder's \textit{tfr}, the drone could have the capability to use this additional information to make better decisions; same consideration applies with the addition of civilian's priorities.
	\begin{enumerate}
		\item If a drone detects a \textit{survivor} and \textit{victim} pair, it will start the communication with the survivor and then give instructions according to the \textit{drone decision policy}. If the drone during its scanning also detected a \textit{first-responder}, then it will instruct the survivor to become an \textit{in contact} civilian, giving it the additional information needed about which first-responder to contact and which victim needs assistance. On the contrary, if there is no near \textit{first-responder}, the drone instructs the survivor to become a \textit{zero-responder}. This design choice ensures the utilization of first-responders' expertise to help two civilians, instead of one, whenever possible (and in a reasonable distance), while also offering the option of helping the victim in need by providing instructions to a fellow civilian to assist it.
		
		\item If a drone does not detect a \textit{survivor} and \textit{victim} pair, it will move following its \textit{drone moving policy}. When drones are deployed into the map, they will start from the top edge and move downwards in a straight line. Then to change direction and come back, the drones do not fly until the limit of the map, but they take into consideration their \textit{nv}s, in order to cover more efficiently the map. This refinement is achievable by simple sensors, that should already be present on the drones. This moving policy has been chosen for its simplicity and practicality in real-life scenarios, because this drone fleet configuration is much easier to control, it covers the most area without using more complex policies and it helps avoiding conflicts between drones, which would create additional confusions in an already difficult and chaotic situation.
	\end{enumerate}
\end{enumerate}
The following are some additional considerations worth pointing out:
\begin{itemize}
	\item 	When a drone decides to instruct a survivor to contact a first-responder, the drone itself sets the first-responder value type to \textit{contacted first-responder}. This is done to ensure no conflicts among drones, and could be achieved in real-life by drones communicating which first-responder has been assigned (recognizing the first-responder by a chip tag). This could also be extended to support quasi-real-time monitoring of first-responders.
	\item 	The drone's committed states are fundamental to ensure atomic actions and avoid conflicts, since no other entity should be able to detect the detected \textit{survivor}, \textit{victim} or \textit{first-responder} (e.g. other drones) and act upon that detection. Moreover, entities should not move and change state (e.g. civilians) while the detection and decision is taking place. The \textit{Patrolling} state has been also marked as committed, even tough not strictly mandatory, in order to convey the idea of the atomic action that a drone makes during a scenario.
\end{itemize}

\paragraph{Stochastic Version}
To account for the stochastic features the drone template has been expanded:
\begin{itemize}
	\item New drone parameter \textit{pfail}: probability expressed by an integer [0, 100], that the detection of entities done by the scanning of a drone does not work.
	\item New probabilistic transition: when a drone detects a \textit{survivor} and \textit{victim} pair, now there is a branch point. A drone will start the communication only with probability \textit{100 - pfail}, while it will ignore the detection with probability \textit{pfail}. This simulates the defect affecting drones' vision sensors.
\end{itemize}
